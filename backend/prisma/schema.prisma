generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////
// ENUMS
///////////////////////

enum Role {
  SUPER_ADMIN
  HR_ADMIN
  MANAGER
  EMPLOYEE
}

enum WeeklyRuleType {
  WORKING
  OFF
  ALTERNATE
}

enum DayType {
  WORKING
  WEEKLY_OFF
  HOLIDAY
}

enum AttendanceType {
  FULL
  HALF_AM
  HALF_PM
  ABSENT
}

enum LeaveDuration {
  FULL
  HALF_AM
  HALF_PM
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

///////////////////////
// AUTH
///////////////////////

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  role          Role
  
  notifications Notification[]
  auditLogs     AuditLog[]
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  employee      Employee?
  sentInvitations Invitation[]
}

///////////////////////
// COMPANY & EMPLOYEE
///////////////////////

model Company {
  id        String   @id @default(uuid())
  name      String
  timezone  String
  employees Employee[]
  calendars Calendar[]
  invitations Invitation[]
}

model Employee {
  id        String   @id @default(uuid())
  userId    String   @unique
  companyId String
  name      String
  status    String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  company   Company  @relation(fields: [companyId], references: [id])

  calendar  EmployeeCalendar?
  attendance Attendance[]
  leaves     LeaveRequest[]
  leaveBalances LeaveBalance[]
}

///////////////////////
// CALENDAR (POLICY)
///////////////////////

model Calendar {
  id              String   @id @default(uuid())
  companyId       String
  name            String
  year            Int

  dayStartTime    String   // "09:00"
  midDayCutoff    String   // "13:00"
  dayEndTime      String   // "18:00"

  createdAt       DateTime @default(now())

  company         Company  @relation(fields: [companyId], references: [id])

  weeklyRules     CalendarWeeklyRule[]
  holidays        CalendarHoliday[]
  employees       EmployeeCalendar[]
}

model EmployeeCalendar {
  id          String   @id @default(uuid())
  employeeId  String   @unique
  calendarId  String

  employee    Employee @relation(fields: [employeeId], references: [id])
  calendar    Calendar @relation(fields: [calendarId], references: [id])
}

///////////////////////
// WEEKLY RULES
///////////////////////

model CalendarWeeklyRule {
  id          String         @id @default(uuid())
  calendarId  String
  dayOfWeek   Int            // 0 = Sunday ... 6 = Saturday
  rule        WeeklyRuleType

  calendar    Calendar       @relation(fields: [calendarId], references: [id])

  @@unique([calendarId, dayOfWeek])
}

///////////////////////
// HOLIDAYS (RANGE-BASED)
///////////////////////

model CalendarHoliday {
  id          String   @id @default(uuid())
  calendarId  String
  startDate   DateTime
  endDate     DateTime
  name        String

  calendar    Calendar @relation(fields: [calendarId], references: [id])

  @@index([calendarId, startDate, endDate])
}

///////////////////////
// ATTENDANCE
///////////////////////

model Attendance {
  id             String          @id @default(uuid())
  employeeId     String
  date           DateTime
  checkIn        DateTime
  checkOut       DateTime?
  attendanceType AttendanceType
  dayType        DayType

  createdAt      DateTime @default(now())

  employee       Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
}

///////////////////////
// LEAVES (RANGE-BASED)
///////////////////////

enum LeaveType {
  ANNUAL
  SICK
  CASUAL
  UNPAID
  MATERNITY
  PATERNITY
  OTHER
}

model LeaveRequest {
  id            String        @id @default(uuid())
  employeeId    String
  startDate     DateTime
  endDate       DateTime
  duration      LeaveDuration
  status        LeaveStatus
  type          LeaveType     @default(ANNUAL) // Defaulting to avoid breaking existing data immediately
  reason        String?
  batchId       String?       // for UI grouping only

  createdAt     DateTime @default(now())

  employee      Employee  @relation(fields: [employeeId], references: [id])

  @@index([employeeId, startDate, endDate])
}

model LeaveBalance {
  id            String    @id @default(uuid())
  employeeId    String
  type          LeaveType
  allocated     Float     @default(0)
  used          Float     @default(0)
  year          Int       

  employee      Employee  @relation(fields: [employeeId], references: [id])
  
  @@unique([employeeId, type, year])
  @@index([employeeId])
}

///////////////////////
// AUDIT LOG
///////////////////////

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  resource   String
  resourceId String
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id])
}

///////////////////////
// NOTIFICATIONS
///////////////////////

model Notification {
  id          String   @id @default(uuid())
  userId      String
  title       String
  message     String
  type        String   // INFO, SUCCESS, WARNING, ERROR
  isRead      Boolean  @default(false)
  actionUrl   String?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  
  @@index([userId, isRead, createdAt])
}

///////////////////////
// INVITATION
///////////////////////

model Invitation {
  id          String   @id @default(uuid())
  email       String
  role        Role
  companyId   String
  token       String   @unique
  expiresAt   DateTime
  invitedBy   String
  status      String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company  @relation(fields: [companyId], references: [id])
  inviter     User     @relation(fields: [invitedBy], references: [id])

  @@index([email, companyId])
  @@index([token])
}