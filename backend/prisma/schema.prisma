generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum Role {
  SUPER_ADMIN // Platform Owner
  ADMIN // SaaS Owner (Organization Owner)
  HR // Organization Admin
  EMPLOYEE // Organization Staff
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveType {
  ANNUAL
  SICK
  CASUAL
  MATERNITY
  PATERNITY
  UNPAID
}

// --- MODELS ---

// --- MODELS ---

model Organization {
  id   String @id @default(uuid())
  name String

  // Relations
  users            User[]
  subscriptions    Subscription[]
  invites          Invite[]
  holidayCalendars HolidayCalendar[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id     String  @id @default(uuid())
  email  String  @unique
  name   String?
  avatar String?

  // Auth Fields
  password String? // Always store HASHED

  role Role @default(EMPLOYEE)

  // Multi-tenancy
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // Holiday Calendar
  holidayCalendarId String?
  holidayCalendar   HolidayCalendar? @relation(fields: [holidayCalendarId], references: [id])

  leaves     Leave[]
  attendance Attendance[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id             String @id @default(uuid())
  organizationId String
  planId         String

  // Billing Info
  orderId    String @unique // From Razorpay/Stripe
  amountPaid Int
  status     String @default("COMPLETED")

  // Validity
  startDate DateTime @default(now())
  endDate   DateTime // Calculated as startDate + plan.durationDays

  organization Organization @relation(fields: [organizationId], references: [id])
  plan         Plan         @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
}

model Plan {
  id           String @id @default(uuid())
  name         String
  price        Int
  durationDays Int
  maxEmployees Int

  subscriptions Subscription[]
}

model Leave {
  id     String @id @default(uuid())
  userId String

  type      LeaveType @default(ANNUAL)
  startDate DateTime
  endDate   DateTime
  totalDays Float // Supports half-days (e.g., 0.5)
  reason    String?

  status     LeaveStatus @default(PENDING)
  adminNotes String? // HR feedback for rejection

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invite {
  id    String @id @default(uuid())
  email String
  token String @unique
  role  Role   @default(EMPLOYEE)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  expiresAt DateTime
  acceptedAt DateTime?
  createdAt DateTime @default(now())

  @@unique([email, organizationId])
}

model HolidayCalendar {
  id          String  @id @default(uuid())
  name        String // e.g., "India Holidays 2025"
  description String?
  year        Int // Year for this calendar

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  holidays Holiday[]
  users    User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, name])
}

model Holiday {
  id          String   @id @default(uuid())
  name        String // e.g., "New Year's Day"
  date        DateTime // The holiday date (or start date)
  endDate     DateTime? // Optional end date for multi-day holidays
  description String? // Optional description

  calendarId String
  calendar   HolidayCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  OFF
  LEAVE
}

model Attendance {
  id      String   @id @default(uuid())
  userId  String
  date    DateTime // Store as midnight UTC or just YYYY-MM-DDT00:00:00.000Z
  clockIn DateTime?
  clockOut DateTime?
  status  AttendanceStatus @default(PRESENT)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
}
