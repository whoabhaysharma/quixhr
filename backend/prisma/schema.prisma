generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. GLOBAL ENUMS
// ==========================================

enum Role {
  SUPER_ADMIN
  ORG_ADMIN
  HR_ADMIN
  MANAGER
  EMPLOYEE
}

enum PaymentProvider {
  RAZORPAY
  STRIPE
  MANUAL         // For Cash/Bank Transfer overrides
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  GRACE_PERIOD
}

enum RuleStrategy {
  CYCLIC          // Every X weeks (1, 2, 3...)
  POSITIONAL      // Specific occurrences (1st, 3rd, Last)
}

enum WeeklyRuleType {
  WORKING
  OFF
  HALF_DAY
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  ON_LEAVE
  HOLIDAY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LedgerEvent {
  ACCRUAL
  CONSUMPTION
  ADJUSTMENT
  IMPORT
  EXPIRY
}

enum LeaveType {
  ANNUAL
  SICK
  CASUAL
  MATERNITY
  PATERNITY
  UNPAID
  OTHER
}

// ==========================================
// 2. PREPAID BILLING (MANUAL PAY)
// ==========================================

model Plan {
  id               String   @id @default(uuid())
  name             String   // "Starter", "Pro"
  
  maxEmployees     Int
  priceMonthly     Float
  priceYearly      Float

  isActive         Boolean  @default(true)
  
  // No "External IDs" needed because we calculate price manually
  subscriptions    Subscription[]
}

model Subscription {
  id               String             @id @default(uuid())
  companyId        String             @unique
  planId           String
  
  status           SubscriptionStatus
  
  // CORE FIELD: The date access expires.
  // Logic: When user pays, validUntil = validUntil + 30 days
  validUntil       DateTime
  
  lastPaymentDate  DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  company          Company            @relation(fields: [companyId], references: [id])
  plan             Plan               @relation(fields: [planId], references: [id])
  payments         Payment[]
}

model Payment {
  id                String          @id @default(uuid())
  subscriptionId    String
  
  amount            Float
  currency          String          @default("INR")
  status            PaymentStatus
  provider          PaymentProvider 
  
  // RAZORPAY STANDARD ORDER FLOW
  // 1. You create an order -> store order_id here
  providerOrderId   String          @unique 
  
  // 2. User pays -> store payment_id here
  providerPaymentId String?         
  
  // Metadata (e.g., "Manual Renewal - 1 Year")
  notes             String?         

  createdAt         DateTime        @default(now())
  subscription      Subscription    @relation(fields: [subscriptionId], references: [id])
}

// ==========================================
// 3. ORGANIZATION & USERS
// ==========================================

model Company {
  id               String       @id @default(uuid())
  name             String
  
  // Settings
  timezone         String       @default("Asia/Kolkata")
  currency         String       @default("INR")
  dateFormat       String       @default("DD/MM/YYYY")
  logoUrl          String?
  
  // Simple link to their membership record
  subscription     Subscription?
  
  employees        Employee[]
  calendars        Calendar[]
  leaveGrades      LeaveGrade[]
  invitations      Invitation[]

  createdAt        DateTime     @default(now())
}

model Invitation {
  id        String   @id @default(uuid())
  companyId String
  email     String
  role      Role
  
  token     String   @unique
  expiresAt DateTime
  status    String   @default("PENDING")

  company   Company  @relation(fields: [companyId], references: [id])
}

model User {
  id              String         @id @default(uuid())
  email           String         @unique
  password        String
  role            Role
  
  isEmailVerified Boolean        @default(false)
  
  passwordResetToken       String?   @unique
  passwordResetExpires     DateTime?
  lastPasswordResetRequest DateTime?
  
  employee        Employee?
  notifications   Notification[]
  auditLogs       AuditLog[]
}

// ==========================================
// 4. EMPLOYEE CORE
// ==========================================

model Employee {
  id           String    @id @default(uuid())
  companyId    String
  userId       String?   @unique

  // 1. Schedule Config
  calendarId   String?
  // 2. Policy Config
  leaveGradeId String?

  firstName    String
  lastName     String
  code         String?   // "EMP-001"
  status       String    // ACTIVE, INACTIVE, PROBATION
  joiningDate  DateTime
  
  user         User?       @relation(fields: [userId], references: [id])
  company      Company     @relation(fields: [companyId], references: [id])
  calendar     Calendar?   @relation(fields: [calendarId], references: [id])
  leaveGrade   LeaveGrade? @relation(fields: [leaveGradeId], references: [id])

  attendance       Attendance[]
  leaveRequests    LeaveRequest[]
  leaveAllocations LeaveAllocation[]
  leaveLedger      LeaveLedger[]
}

// ==========================================
// 5. WORK ENGINE (CALENDARS)
// ==========================================

model Calendar {
  id           String             @id @default(uuid())
  companyId    String
  name         String             // "General Shift"

  dayStartTime Int                // Minutes from midnight
  dayEndTime   Int

  weeklyRules  CalendarWeeklyRule[]
  holidays     CalendarHoliday[]
  employees    Employee[]

  company      Company            @relation(fields: [companyId], references: [id])
}

model CalendarWeeklyRule {
  id            String         @id @default(uuid())
  calendarId    String
  dayOfWeek     Int            // 0-6
  
  type          WeeklyRuleType
  strategy      RuleStrategy 
  
  // Strategy A: Cyclic (Every X weeks)
  interval      Int?           @default(1)
  referenceDate DateTime?

  // Strategy B: Positional (2nd & 4th)
  positions     Int[]          // [2, 4] or [-1]

  calendar      Calendar       @relation(fields: [calendarId], references: [id])
}

model CalendarHoliday {
  id          String   @id @default(uuid())
  calendarId  String
  date        DateTime @db.Date
  name        String
  isOptional  Boolean  @default(false)

  calendar    Calendar @relation(fields: [calendarId], references: [id])
  @@unique([calendarId, date])
}

// ==========================================
// 6. LEAVE ENGINE (GRADES & LEDGER)
// ==========================================

model LeaveGrade {
  id          String        @id @default(uuid())
  companyId   String
  name        String        // "Full Time Staff"
  
  policies    LeavePolicy[]
  employees   Employee[]
  company     Company       @relation(fields: [companyId], references: [id])
}

model LeavePolicy {
  id             String     @id @default(uuid())
  leaveGradeId   String
  leaveType      LeaveType
  
  totalDays      Float
  carryForward   Boolean    @default(false)
  maxCarryAmount Float      @default(0)

  grade          LeaveGrade @relation(fields: [leaveGradeId], references: [id])
  @@unique([leaveGradeId, leaveType])
}

// The Wallet (Balance Cache)
model LeaveAllocation {
  id          String    @id @default(uuid())
  employeeId  String
  year        Int
  leaveType   LeaveType
  
  allocated   Float     @default(0)
  used        Float     @default(0)

  employee    Employee  @relation(fields: [employeeId], references: [id])
  @@unique([employeeId, year, leaveType])
}

// The Ledger (Audit History)
model LeaveLedger {
  id             String      @id @default(uuid())
  employeeId     String
  createdAt      DateTime    @default(now())
  
  event          LedgerEvent
  amount         Float       // +1.0 or -1.0
  remarks        String?
  leaveRequestId String?

  employee       Employee    @relation(fields: [employeeId], references: [id])
}

model LeaveRequest {
  id          String      @id @default(uuid())
  employeeId  String
  
  startDate   DateTime
  endDate     DateTime
  daysTaken   Float
  
  type        LeaveType
  status      LeaveStatus
  reason      String?
  
  // JSON metadata for complex half-day logic
  dayDetails  Json?       
  
  approvedBy  String?
  createdAt   DateTime    @default(now())

  employee    Employee    @relation(fields: [employeeId], references: [id])
}

// ==========================================
// 7. ATTENDANCE ENGINE
// ==========================================

model Attendance {
  id           String           @id @default(uuid())
  employeeId   String
  date         DateTime         @db.Date
  
  status       AttendanceStatus
  
  // Independent Flags
  isLate       Boolean          @default(false)
  isEarlyOut   Boolean          @default(false)
  
  // Time Data
  checkIn      DateTime?
  checkOut     DateTime?
  workMinutes  Int              @default(0)
  overtimeMins Int              @default(0)

  logs         AttendanceLog[]
  employee     Employee         @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
  @@index([date])
}

model AttendanceLog {
  id           String     @id @default(uuid())
  attendanceId String
  
  timestamp    DateTime
  type         String     // "IN" or "OUT"
  method       String?    // "BIOMETRIC", "WEB", "MOBILE"
  gpsCoords    Json?      

  attendance   Attendance @relation(fields: [attendanceId], references: [id])
}

// ==========================================
// 8. SYSTEM LOGS
// ==========================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  action     String   // "DELETE_EMPLOYEE"
  resource   String   // "Employee"
  resourceId String
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}